<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]>      <html class="no-js"> <!--<![endif]-->
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Create your 4x6 Passport Photo</title>
    <meta
      name="description"
      content="Convert your cropped Passport Photo into a 4x6 Photo format to cheaply print!"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="" />
    <style>
      .responsive {
        max-width: 100%;
        height: auto;
      }
      #input-photo {
        margin-bottom: 2em;
      }
    </style>
  </head>
  <body>
    <!--[if lt IE 7]>
      <p class="browsehappy">
        You are using an <strong>outdated</strong> browser. Please
        <a href="#">upgrade your browser</a> to improve your experience.
      </p>
    <![endif]-->
    <h1>
      Go to
      <a href="https://tsg.phototool.state.gov/photo" target="_blank"
        >U.S. Passport Photos - United States Department of State</a
      >
      to get your cropped passport photo.
    </h1>
    <h1>Upload your photo (JPEG)</h1>
    <input type="file" accept="image/jpeg" id="input-photo" />
    <div>
      <button id="orientation-btn" onclick="toggleOrientation()">
        Toggle Orientation
      </button>
      <button id="download" onclick="downloadCanvas()">
        Download your 4x6 Passport Photo
      </button>
    </div>

    <script>
      console.log("Script started: " + length);
      const inputElement = document.getElementById("input-photo");
      inputElement.addEventListener("change", handleFiles, false);
      var fileUploaded = false;
      //If true, portrait 4x6. Else, landscape 4x6
      var orientation = false;
      //Global Photo URL
      var PhotoLiveURL = null;

      function handleFiles() {
        let fileList = this.files; /* now you can work with the file list */
        if (fileList.length != 0 && fileList[0].type != "image/jpeg") {
          alert("Please only upload a JPEG file.");
          return;
        } else if (fileList.length == 0) {
          console.log("No file uploaded, don't run the rest of the script.");
          return;
        }

        //If a new fil/photo is uploaded, reset photos and canvas, then release ObjectURL
        if (fileUploaded) {
          let photo = document.getElementById("uploaded_photo");
          let currentCanvas = document.getElementById("photo_canvas");
          let uploadedTitle = document.getElementById("upload-title");
          photo.remove();
          currentCanvas.remove();
          uploadedTitle.remove();
          //Must do memory management for object URLs. They'll be released when the user leaves the website.
          URL.revokeObjectURL(PhotoLiveURL);
        }
        //Only one photo can be uploaded, thus only check 1st element.
        PhotoLiveURL = URL.createObjectURL(fileList[0]);
        showFile(fileList);
        fileUploaded = true;
      }

      function showFile(fileList) {
        const title = document.createElement("h1");
        title.innerHTML = "Uploaded File: ";
        title.id = "upload-title";
        document.body.appendChild(title);

        let photo_html = new Image();
        photo_html.src = PhotoLiveURL;
        photo_html.setAttribute("id", "uploaded_photo");
        photo_html.setAttribute("style", "display: block; margin-bottom: 1em;");
        photo_html.classList.add("responsive");
        photo_html.onload = function () {
          create4x6_portrait(photo_html);
        };
        document.body.appendChild(photo_html);

        orientation = true;
      }

      function toggleOrientation() {
        if (fileUploaded) {
          let photo = document.getElementById("uploaded_photo");
          let currentCanvas = document.getElementById("photo_canvas");
          currentCanvas.remove();

          if (orientation) {
            create4x6_landscape(photo);
            orientation = false;
          } else {
            create4x6_portrait(photo);
            orientation = true;
          }
        } else {
          alert("Please upload a photo first ðŸ¤¡");
        }
      }

      function create4x6_portrait(photo_html) {
        let canvas = document.createElement("canvas");
        canvas.setAttribute("id", "photo_canvas");
        canvas.setAttribute("width", photo_html.width * 2);
        canvas.setAttribute("height", photo_html.height * 3);
        canvas.classList.add("responsive");
        document.body.appendChild(canvas);
        let html_canvas = document
          .getElementById("photo_canvas")
          .getContext("2d");

        html_canvas.drawImage(photo_html, 0, 0);
        html_canvas.drawImage(photo_html, photo_html.clientWidth, 0);
        html_canvas.drawImage(photo_html, 0, photo_html.clientWidth);
        html_canvas.drawImage(
          photo_html,
          photo_html.clientWidth,
          photo_html.clientWidth
        );
        html_canvas.drawImage(photo_html, 0, photo_html.clientWidth * 2);
        html_canvas.drawImage(
          photo_html,
          photo_html.clientWidth,
          photo_html.clientWidth * 2
        );
        console.log("Created portrait 4x6 photo.");
      }

      function create4x6_landscape(photo_html) {
        let canvas = document.createElement("canvas");
        canvas.setAttribute("id", "photo_canvas");
        canvas.setAttribute("width", photo_html.height * 3);
        canvas.setAttribute("height", photo_html.width * 2);
        canvas.classList.add("responsive");
        document.body.appendChild(canvas);
        let html_canvas = document
          .getElementById("photo_canvas")
          .getContext("2d");

        html_canvas.drawImage(photo_html, 0, 0);
        html_canvas.drawImage(photo_html, photo_html.clientWidth, 0);
        html_canvas.drawImage(photo_html, photo_html.clientWidth * 2, 0);
        html_canvas.drawImage(photo_html, 0, photo_html.clientWidth);
        html_canvas.drawImage(
          photo_html,
          photo_html.clientWidth,
          photo_html.clientWidth
        );
        html_canvas.drawImage(
          photo_html,
          photo_html.clientWidth * 2,
          photo_html.clientWidth
        );
        console.log("Created landscape 4x6 photo.");
      }

      function downloadCanvas() {
        if (fileUploaded) {
          let html_canvas = document.getElementById("photo_canvas");
          let fullQuality = html_canvas.toDataURL("image/jpeg", 1.0);

          let file = document.createElement("a");
          file.href = fullQuality;
          file.download = "4x6PassportPhoto";
          file.click();
        } else {
          alert("Please upload a photo first ðŸ¤¡");
        }
      }
    </script>
  </body>
</html>
